AWSTemplateFormatVersion: '2010-09-09'
Description: CodePipeline que despliega Infra y API en dev, test, prod

Resources:

  ##########################
  # Role para CodePipeline
  ##########################
  CodePipelineRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: CodePipelineServiceRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: codepipeline.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AWSCodePipelineFullAccess
        - arn:aws:iam::aws:policy/AWSCodeBuildDeveloperAccess
        - arn:aws:iam::aws:policy/AWSCloudFormationFullAccess
        - arn:aws:iam::aws:policy/AmazonS3FullAccess

  ##########################
  # Artifact Store (S3)
  ##########################
  PipelineArtifactBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub codepipeline-artifacts-${AWS::AccountId}-${AWS::Region}

  ##########################
  # CodePipeline
  ##########################
  DeploymentPipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      Name: ServerlessCrudPipeline
      RoleArn: !GetAtt CodePipelineRole.Arn
      ArtifactStore:
        Type: S3
        Location: !Ref PipelineArtifactBucket
      Stages:
        - Name: Source
          Actions:
            - Name: GitHubSource
              ActionTypeId:
                Category: Source
                Owner: ThirdParty
                Provider: GitHub
                Version: '1'
              Configuration:
                Owner: manueleperez
                Repo: code-challenges-serverless-guru
                Branch: main
                OAuthToken: "{{resolve:secretsmanager:github-token:SecretString:token}}"
              OutputArtifacts:
                - Name: SourceOutput

        - Name: Build
          Actions:
            - Name: CodeBuildAction
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: '1'
              InputArtifacts:
                - Name: SourceOutput
              OutputArtifacts:
                - Name: BuildOutput
              Configuration:
                ProjectName: MiProyectoBuild

        # -------------------
        # Deploy en DEV
        # -------------------
        - Name: DeployInfraDev
          Actions:
            - Name: DeployInfraStackDev
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: '1'
              InputArtifacts:
                - Name: BuildOutput
              Configuration:
                ActionMode: CREATE_UPDATE
                StackName: infra-dev
                TemplatePath: BuildOutput::template/infra.yml
                Capabilities: CAPABILITY_NAMED_IAM

        - Name: DeployApiDev
          Actions:
            - Name: DeployApiStackDev
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: '1'
              InputArtifacts:
                - Name: BuildOutput
              Configuration:
                ActionMode: CREATE_UPDATE
                StackName: api-dev
                TemplatePath: BuildOutput::template/api.yml

        # -------------------
        # Deploy en TEST
        # -------------------
        - Name: DeployInfraTest
          Actions:
            - Name: DeployInfraStackTest
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: '1'
              InputArtifacts:
                - Name: BuildOutput
              Configuration:
                ActionMode: CREATE_UPDATE
                StackName: infra-test
                TemplatePath: BuildOutput::template/infra.yml
                Capabilities: CAPABILITY_NAMED_IAM

        - Name: DeployApiTest
          Actions:
            - Name: DeployApiStackTest
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: '1'
              InputArtifacts:
                - Name: BuildOutput
              Configuration:
                ActionMode: CREATE_UPDATE
                StackName: api-test
                TemplatePath: BuildOutput::template/api.yml

        # -------------------
        # Deploy en PROD
        # -------------------
        - Name: DeployInfraProd
          Actions:
            - Name: DeployInfraStackProd
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: '1'
              InputArtifacts:
                - Name: BuildOutput
              Configuration:
                ActionMode: CREATE_UPDATE
                StackName: infra-prod
                TemplatePath: BuildOutput::template/infra.yml
                Capabilities: CAPABILITY_NAMED_IAM

        - Name: DeployApiProd
          Actions:
            - Name: DeployApiStackProd
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: '1'
              InputArtifacts:
                - Name: BuildOutput
              Configuration:
                ActionMode: CREATE_UPDATE
                StackName: api-prod
                TemplatePath: BuildOutput::template/api.yml

Outputs:
  PipelineName:
    Value: !Ref DeploymentPipeline
    Export:
      Name: ServerlessCrudPipeline